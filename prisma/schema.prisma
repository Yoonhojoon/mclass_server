generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(uuid())
  email              String              @unique
  password           String?
  name               String?
  role               UserRole            @default(USER)
  provider           Provider            @default(LOCAL)
  createdAt          DateTime            @default(now()) @map("created_at")
  isAdmin            Boolean             @default(false) @map("is_admin")
  isSignUpCompleted  Boolean             @default(false) @map("is_sign_up_completed")
  socialId           String?             @map("social_id")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  decidedByAdmin     Enrollment[]        @relation("AdminDecisions")
  enrollments        Enrollment[]
  mclasses           MClass[]
  userTermAgreements UserTermAgreement[]

  @@unique([provider, socialId])
  @@map("users")
}

model MClass {
  id               String          @id @default(uuid())
  title            String
  description      String?
  capacity         Int?
  visibility       Visibility      @default(PUBLIC)
  location         String?
  fee              Int?
  allowWaitlist    Boolean         @default(false) @map("allow_waitlist")
  createdAt        DateTime        @default(now()) @map("created_at")
  createdBy        String          @map("created_by")
  endAt            DateTime        @map("end_at")
  isOnline         Boolean         @default(true) @map("is_online")
  recruitEndAt     DateTime        @map("recruit_end_at")
  recruitStartAt   DateTime        @map("recruit_start_at")
  selectionType    SelectionType   @default(FIRST_COME) @map("selection_type")
  startAt          DateTime        @map("start_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")
  waitlistCapacity Int?            @map("waitlist_capacity")
  enrollmentForm   EnrollmentForm?
  enrollments      Enrollment[]
  creator          User            @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([visibility, recruitStartAt, recruitEndAt])
  @@index([startAt])
  @@map("mclasses")
}

model Term {
  id                 String              @id @default(uuid())
  type               TermType
  title              String
  content            String
  isRequired         Boolean             @default(false) @map("isRequired")
  version            String
  createdAt          DateTime            @default(now()) @map("createdAt")
  userTermAgreements UserTermAgreement[]

  @@map("terms")
}

model UserTermAgreement {
  id       String   @id @default(uuid())
  agreedAt DateTime @default(now()) @map("agreed_at")
  termId   String   @map("term_id")
  userId   String   @map("user_id")
  term     Term     @relation(fields: [termId], references: [id])
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, termId])
  @@map("user_term_agreements")
}

model Enrollment {
  id               String           @id @default(uuid())
  answers          Json
  status           EnrollmentStatus @default(APPLIED)
  reason           String?
  version          Int              @default(1) @map("version")
  appliedAt        DateTime         @default(now()) @map("applied_at")
  canceledAt       DateTime?        @map("canceled_at")
  createdAt        DateTime         @default(now()) @map("created_at")
  decidedAt        DateTime?        @map("decided_at")
  decidedByAdminId String?          @map("decided_by_admin_id")
  enrollmentFormId String           @map("enrollment_form_id")
  formSnapshot     Json?            @map("form_snapshot")
  formVersion      Int              @default(1) @map("form_version")
  idempotencyKey   String?          @unique @map("idempotency_key")
  mclassId         String           @map("mclass_id")
  reasonType       ReasonType?      @map("reason_type")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  userId           String           @map("user_id")
  decidedByAdmin   User?            @relation("AdminDecisions", fields: [decidedByAdminId], references: [id], onDelete: SetNull)
  enrollmentForm   EnrollmentForm   @relation(fields: [enrollmentFormId], references: [id], onDelete: Cascade)
  mclass           MClass           @relation(fields: [mclassId], references: [id], onDelete: Cascade)
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, mclassId])
  @@index([mclassId, status])
  @@index([userId])
  @@index([mclassId, status, appliedAt])
  @@map("enrollments")
}

model EnrollmentForm {
  id          String       @id @default(uuid())
  title       String
  description String?
  questions   Json
  createdAt   DateTime     @default(now()) @map("created_at")
  isActive    Boolean      @default(true) @map("is_active")
  mclassId    String       @unique @map("mclass_id")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  mclass      MClass       @relation(fields: [mclassId], references: [id], onDelete: Cascade)
  enrollments Enrollment[]

  @@map("enrollment_forms")
}

model EmailOutbox {
  id          String    @id @default(uuid())
  type        EmailType
  to          String
  subject     String?
  payload     Json
  template    String
  attempts    Int       @default(0)
  error       String?
  createdAt   DateTime  @default(now()) @map("created_at")
  nextTryAt   DateTime? @map("next_try_at")
  processedAt DateTime? @map("processed_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([type, processedAt])
  @@index([nextTryAt, attempts])
  @@map("email_outbox")
}

enum UserRole {
  USER
  ADMIN
}

enum Provider {
  LOCAL
  KAKAO
  GOOGLE
  NAVER
}

enum TermType {
  SERVICE
  PRIVACY
  ENROLLMENT
}

enum Gender {
  M
  F
}

enum SelectionType {
  FIRST_COME
  REVIEW
}

enum Visibility {
  PUBLIC
  UNLISTED
}

enum EnrollmentStatus {
  APPLIED
  APPROVED
  REJECTED
  WAITLISTED
  CANCELED
}

enum ReasonType {
  REJECT
  CANCEL
}

enum EmailType {
  ENROLLMENT_APPLIED
  ENROLLMENT_APPROVED
  ENROLLMENT_REJECTED
  ENROLLMENT_WAITLISTED
  ENROLLMENT_CANCELED
  WAITLIST_PROMOTED
}
