generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(uuid())
  email              String              @unique
  password           String?
  name               String?
  role               UserRole            @default(USER)
  isAdmin            Boolean             @default(false) @map("is_admin")
  provider           Provider            @default(LOCAL)
  socialId           String?             @map("social_id")
  isSignUpCompleted  Boolean             @default(false) @map("is_sign_up_completed")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  enrollments        Enrollment[]
  mclasses           MClass[]
  userTermAgreements UserTermAgreement[]
  decidedByAdmin     Enrollment[]        @relation("AdminDecisions")

  @@unique([provider, socialId])
  @@map("users")
}

model MClass {
  id               String          @id @default(uuid())
  title            String
  description      String?
  recruitStartAt   DateTime        @map("recruit_start_at")
  recruitEndAt     DateTime        @map("recruit_end_at")
  startAt          DateTime        @map("start_at")
  endAt            DateTime        @map("end_at")
  selectionType    SelectionType   @default(FIRST_COME) @map("selection_type")
  capacity         Int?
  allowWaitlist    Boolean         @default(false) @map("allow_waitlist")
  waitlistCapacity Int?            @map("waitlist_capacity")
  visibility       Visibility      @default(PUBLIC)
  isOnline         Boolean         @default(true) @map("is_online")
  location         String?
  fee              Int?
  createdBy        String          @map("created_by")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")
  enrollmentForm   EnrollmentForm?
  enrollments      Enrollment[]
  creator          User            @relation(fields: [createdBy], references: [id])

  @@index([visibility, recruitStartAt, recruitEndAt])
  @@index([startAt])
  @@map("mclasses")
}

model Term {
  id                 String              @id @default(uuid())
  type               TermType
  title              String
  content            String
  isRequired         Boolean             @default(false) @map("isRequired")
  version            String
  createdAt          DateTime            @default(now()) @map("createdAt")
  userTermAgreements UserTermAgreement[]

  @@map("terms")
}

model UserTermAgreement {
  id       String   @id @default(uuid())
  userId   String   @map("user_id")
  termId   String   @map("term_id")
  agreedAt DateTime @default(now()) @map("agreed_at")
  term     Term     @relation(fields: [termId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@unique([userId, termId])
  @@map("user_term_agreements")
}

model Enrollment {
  id               String           @id @default(uuid())
  userId           String           @map("user_id")
  mclassId         String           @map("mclass_id")
  enrollmentFormId String           @map("enrollment_form_id")
  answers          Json
  status           EnrollmentStatus @default(APPLIED)
  appliedAt        DateTime         @default(now()) @map("applied_at")
  decidedAt        DateTime?        @map("decided_at")
  canceledAt       DateTime?        @map("canceled_at")
  reason           String?
  
  // 버전 관리 필드
  formVersion      Int              @default(1) @map("form_version")
  formSnapshot     Json?            @map("form_snapshot") // 폼 수정 시 히스토리 보존용
  
  // 감사 추적 필드
  decidedByAdminId String?          @map("decided_by_admin_id") // 승인/거절/대기 결정한 관리자
  reasonType       ReasonType?      @map("reason_type") // 사유 타입 구분
  
  // 멱등성 필드
  idempotencyKey   String?          @unique @map("idempotency_key") // 중복 요청 방지
  
  // 낙관적 락
  version          Int              @default(1) @map("version") // rowVersion
  
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  enrollmentForm   EnrollmentForm   @relation(fields: [enrollmentFormId], references: [id], onDelete: Cascade)
  mclass           MClass           @relation(fields: [mclassId], references: [id], onDelete: Cascade)
  user             User             @relation(fields: [userId], references: [id])
  decidedByAdmin   User?            @relation("AdminDecisions", fields: [decidedByAdminId], references: [id])

  @@unique([userId, mclassId])
  @@index([mclassId, status])
  @@index([userId])
  @@index([mclassId, status, appliedAt]) // 대기열 FIFO 처리용 인덱스
  @@map("enrollments")
}

model EnrollmentForm {
  id          String       @id @default(uuid())
  mclassId    String       @unique @map("mclass_id")
  title       String
  description String?
  questions   Json
  isActive    Boolean      @default(true) @map("is_active")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  mclass      MClass       @relation(fields: [mclassId], references: [id], onDelete: Cascade)
  enrollments Enrollment[]

  @@map("enrollment_forms")
}

// 이메일 아웃박스 패턴
model EmailOutbox {
  id          String           @id @default(uuid())
  type        EmailType        // 이메일 타입
  to          String           // 수신자 이메일
  subject     String?          // 제목 (템플릿에서 생성)
  payload     Json             // 이메일 데이터
  template    String           // 템플릿 이름
  attempts    Int              @default(0) // 재시도 횟수
  nextTryAt   DateTime?        @map("next_try_at") // 다음 재시도 시간
  processedAt DateTime?        @map("processed_at") // 발송 완료 시간
  error       String?          // 마지막 에러 메시지
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  @@index([type, processedAt])
  @@index([nextTryAt, attempts])
  @@map("email_outbox")
}

enum UserRole {
  USER
  ADMIN
}

enum Provider {
  LOCAL
  KAKAO
  GOOGLE
  NAVER
}

enum TermType {
  SERVICE
  PRIVACY
  ENROLLMENT
}

enum Gender {
  M
  F
}

enum SelectionType {
  FIRST_COME
  REVIEW
}

enum Visibility {
  PUBLIC
  UNLISTED
}

enum EnrollmentStatus {
  APPLIED
  APPROVED
  REJECTED
  WAITLISTED
  CANCELED
}

enum ReasonType {
  REJECT
  CANCEL
}

enum EmailType {
  ENROLLMENT_APPLIED
  ENROLLMENT_APPROVED
  ENROLLMENT_REJECTED
  ENROLLMENT_WAITLISTED
  ENROLLMENT_CANCELED
  WAITLIST_PROMOTED
}
