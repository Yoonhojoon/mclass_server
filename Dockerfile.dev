FROM node:18-alpine

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# package.jsonê³¼ package-lock.json ë³µì‚¬
COPY package*.json ./

# ê°œë°œ ì˜ì¡´ì„± í¬í•¨í•˜ì—¬ ì„¤ì¹˜
RUN npm ci

# ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY . .

# ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
RUN echo '#!/bin/sh' > /app/start-dev.sh && \
    echo 'echo "ğŸ”„ ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘..."' >> /app/start-dev.sh && \
    echo 'npx prisma migrate deploy' >> /app/start-dev.sh && \
    echo 'if [ $? -eq 0 ]; then' >> /app/start-dev.sh && \
    echo '  echo "âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ"' >> /app/start-dev.sh && \
    echo '  echo "ğŸš€ ê°œë°œ ì„œë²„ ì‹œì‘..."' >> /app/start-dev.sh && \
    echo '  exec npm run dev' >> /app/start-dev.sh && \
    echo 'else' >> /app/start-dev.sh && \
    echo '  echo "âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨"' >> /app/start-dev.sh && \
    echo '  exit 1' >> /app/start-dev.sh && \
    echo 'fi' >> /app/start-dev.sh && \
    chmod +x /app/start-dev.sh

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 3000

# ê°œë°œ ëª¨ë“œë¡œ ì‹¤í–‰ (ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ì„œë²„ ì‹œì‘)
CMD ["/app/start-dev.sh"] 